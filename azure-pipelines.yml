trigger:
- main

jobs:
- job: BuildAngularApp
  displayName: 'Build Angular App'
  steps:
    - script: |
        echo "Running Angular build "
        # Install Node.js
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs

        # Install Angular CLI and build
        npm install -g @angular/cli
        npm install
        ng build --output-path="dist"
    - publish: $(System.DefaultWorkingDirectory)/dist
      artifact: AngularBuild
- deployment: DeployAngularToVM
  displayName: 'Deploy Angular App to TestDEV VM'
  environment: 'TestDEV'
  dependsOn: 'BuildAngularApp'
  strategy:
    runOnce:
      deploy:
        steps:
          - task: CopyFilesOverSSH@0
            inputs:
              sshEndpoint: 'Test-Linux'
              sourceFolder: '$(Pipeline.Workspace)'
              contents: '**'
              targetFolder: '/opt/'
              readyTimeout: '20000'